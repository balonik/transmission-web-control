// Torrent related information
transmission.torrents={all:null,puased:null,downloading:null,actively:null,searchResult:null,error:null,warning:null,folders:{},status:{},count:0,totalSize:0,loadSimpleInfo:!1,activeTorrentCount:0,pausedTorrentCount:0,fields:{base:"id,name,status,hashString,totalSize,percentDone,addedDate,trackerStats,leftUntilDone,rateDownload,rateUpload,recheckProgress,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,downloadDir,error,errorString,doneDate,queuePosition",status:"id,status,percentDone,trackerStats,leftUntilDone,rateDownload,rateUpload,rateDownload,rateUpload,peersGettingFromUs,peersSendingToUs,uploadRatio,uploadedEver,downloadedEver,error,errorString,doneDate,queuePosition",config:"downloadLimit,downloadLimited,peer-limit,seedIdleLimit,seedIdleMode,seedRatioLimit,seedRatioMode,uploadLimit,uploadLimited"},datas:{},recently:null,removed:null,isRecentlyActive:!1,newIds:new Array,getallids:function(e,t,n){var s=this.fields.base
this.loadSimpleInfo&&this.all&&(s=this.fields.status)
var r=s.split(",")
$.isArray(n)&&$.unique($.merge(r,n))
var arguments={fields:r}
this.isRecentlyActive=!1,this.all&&void 0==t?(arguments.ids="recently-active",this.isRecentlyActive=!0):t&&(arguments.ids=t),this.all||(this.all={}),transmission.exec({method:"torrent-get",arguments:arguments},function(t){"success"==t.result?(transmission.torrents.newIds.length=0,transmission.torrents.loadSimpleInfo=!0,transmission.torrents.recently=t.arguments.torrents,transmission.torrents.removed=t.arguments.removed,transmission.torrents.splitid(),e&&e(t.arguments.torrents)):(transmission.torrents.datas=null,e&&e(null))})},splitid:function(){this.downloading=new Array,this.puased=new Array,this.actively=new Array,this.error=new Array,this.warning=new Array,transmission.downloadDirs=new Array
var e=transmission._status
this.status={},transmission.trackers={},this.totalSize=0,this.folders={},this.count=0
var t=new Base64
for(var n in this.recently){var s=this.recently[n]
this.datas[s.id]=s}var r=new Array
for(var n in this.removed){var s=this.removed[n]
r.push(s)}for(var n in this.datas){var s=this.datas[n]
if(!s)return
if($.inArray(s.id,r)!=-1&&r.length>0)this.all[s.id]&&(this.all[s.id]=null,delete this.all[s.id]),this.datas[n]=null,delete this.datas[n]
else{this.isRecentlyActive&&!this.all[s.id]&&this.newIds.push(s.id),s=$.extend(this.all[s.id],s),0==s.uploadedEver&&0==s.downloadedEver&&(s.uploadRatio="∞"),s.infoIsLoading=!1
var i=this.status[s.status]
switch(this.addTracker(s),i||(this.status[s.status]=new Array,i=this.status[s.status]),this.totalSize+=s.totalSize,s.rateDownload>0&&s.leftUntilDone>0?(s.remainingTime=getTotalTime(s.leftUntilDone/s.rateDownload*1e3),s.remainingTimeRaw=Math.floor(s.leftUntilDone/s.rateDownload*1e3)):0==s.rateDownload&&0==s.leftUntilDone&&0!=s.totalSize?(s.remainingTime=0,s.remainingTimeRaw=0):(s.remainingTime="∞",s.remainingTimeRaw=31536e8),i.push(s),0!=s.error&&this.error.push(s),(s.rateUpload>0||s.rateDownload>0)&&this.actively.push(s),s.status){case e.stopped:this.puased.push(s)
break
case e.download:this.downloading.push(s)}if(this.all[s.id]=s,$.inArray(s.downloadDir,transmission.downloadDirs)==-1&&transmission.downloadDirs.push(s.downloadDir),transmission.options.getFolders&&s.downloadDir){var a=s.downloadDir.split("/"),o="folders-"
for(var l in a){var d=a[l]
if(""!=d){o+=t.encode(d)
var u=this.folders[o]
u||(u={count:0,torrents:new Array,size:0,nodeid:o}),u.torrents.push(s),u.count++,u.size+=s.totalSize,this.folders[o]=u}}}this.count++}}transmission.downloadDirs=transmission.downloadDirs.sort(),this.newIds.length>0&&this.getallids(null,this.newIds)},addTracker:function(e){var t=e.trackerStats,n=!1
if(e.leecherCount=0,e.seederCount=0,t.length>0){for(var s in t){var r=t[s],i=r.lastAnnounceResult.toLowerCase(),a=r.host.replace("http://","").replace("https://","").split(":")[0].split(".")
$.inArray(a[0],"www,tracker".split(","))!=-1&&a.shift()
var o=a.join("."),l="tracker-"+o.replace(/\./g,"-"),d=transmission.trackers[l]
d||(transmission.trackers[l]={count:0,torrents:new Array,size:0,connected:!0},d=transmission.trackers[l]),d.name=o,d.nodeid=l,d.host=r.host,r.lastAnnounceSucceeded||r.announceState==transmission._trackerStatus.inactive||(n=!0,e.warning=r.lastAnnounceResult,"could not connect to tracker"==i&&(d.connected=!1)),d.torrents.push(e),d.count++,d.size+=e.totalSize,e.leecherCount+=r.leecherCount,e.seederCount+=r.seederCount}n&&(e.nextAnnounceTime?e.nextAnnounceTime>r.nextAnnounceTime&&(e.nextAnnounceTime=r.nextAnnounceTime):e.nextAnnounceTime=r.nextAnnounceTime,this.warning.push(e)),e.leecherCount<0&&(e.leecherCount=0),e.seederCount<0&&(e.seederCount=0),e.leecher=e.leecherCount+" ("+e.peersGettingFromUs+")",e.seeder=e.seederCount+" ("+e.peersSendingToUs+")"}},getPeers:function(e){transmission.exec({method:"torrent-get",arguments:{fields:"peers,peersFrom".split(","),ids:e}},function(e){console.log("data:",e)})},getMoreInfos:function(e,t,n){transmission.exec({method:"torrent-get",arguments:{fields:e.split(","),ids:t}},function(e){"success"==e.result?n&&n(e.arguments.torrents):n&&n(null)})},search:function(e,t){if(!e)return null
t||(t=this.all)
var n=new Array
return $.each(t,function(s,r){t[s].name.toLowerCase().indexOf(e.toLowerCase())!=-1&&n.push(t[s])}),this.searchResult=n,n},getFiles:function(e,t){transmission.exec({method:"torrent-get",arguments:{fields:"files,fileStats".split(","),ids:e}},function(e){"success"==e.result?t&&t(e.arguments.torrents):t&&t(null)})},getConfig:function(e,t){this.getMoreInfos(this.fields.config,e,t)},getErrorIds:function(e,t){var n=new Array,s=new Date
1==t&&(s=s.getTime()/1e3)
for(var r in this.error){var i=this.error[r]
$.inArray(i.id,e)!=-1&&e.length>0||1==t&&s<i.nextAnnounceTime||i.status!=transmission._status.stopped&&n.push(i.id)}for(var r in this.warning){var i=this.warning[r]
$.inArray(i.id,e)!=-1&&e.length>0||1==t&&s<i.nextAnnounceTime||n.push(i.id)}return n},searchAndReplaceTrackers:function(e,t,n){if(e&&t){var s={},r=0
for(var i in this.all){var a=this.all[i]
if(!a)return
var o=a.trackerStats
for(var l in o){var d=o[l]
d.announce==e&&(s[l]||(s[l]={ids:new Array,tracker:t}),s[l].ids.push(a.id),r++)}}0==r&&n&&n(null,0)
for(var i in s)transmission.exec({method:"torrent-set",arguments:{ids:s[i].ids,trackerReplace:[parseInt(i),s[i].tracker]}},function(e,t){"success"==e.result?n&&n(t,r):n&&n(null)},s[i].ids)}}}
